name: Infrastructure Provisioning

on:
    workflow_dispatch:
    push:
        branches:
            - main
        #paths:
        #    - "terraform/**"

jobs:
    plan:
        name: Terraform Plan
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./terraform/team-01

        steps:
            - name: Checkout 
              uses: actions/checkout@v5.0.0

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4.3.1
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ vars.REGION }}
            
            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3.1.2

            - name: Terraform Init
              run: terraform init

            - name: Terraform Validate
              run: terraform validate

            - name: Terraform Plan
              run: terraform plan -out=tfplan

            - name: Upload plan artifact
              uses: actions/upload-artifact@v4
              with:
                  name: tfplan
                  path: ./terraform/team-01/tfplan

    apply:
        name: Terraform Apply
        needs: plan
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./terraform/team-01
                
        environment:
            name: production
            url: https://console.aws.amazon.com
        steps:
            - name: Checkout 
              uses: actions/checkout@v5.0.0  

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4.3.1
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ vars.REGION }}    
            
            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3.1.2  
              
            - name: Terraform Init
              run: terraform init

            - name: Download plan artifact
              uses: actions/download-artifact@v4
              with:
                  name: tfplan  
                  path: ./terraform/team-01
                
            - name: Terraform Apply
              run: terraform apply -auto-approve tfplan

            - name: Upload Terraform State
              uses: actions/upload-artifact@v4
              with:
                  name: tfstate
                  path: ./terraform/team-01/terraform.tfstate

    terraform-destroy:
        runs-on: ubuntu-latest
        needs: apply
        defaults:
            run:
                working-directory: ./terraform/team-01
                
        steps:
          - uses: actions/checkout@v5.0.0

          - name: Configure AWS Credentials
            uses: aws-actions/configure-aws-credentials@v4.3.1
            with:
                aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                aws-region: ${{ vars.REGION }}

          - name: Setup Terraform
            uses: hashicorp/setup-terraform@v3.1.2

          - name: Terraform Init
            run: terraform init

          - name: Download Terraform State
            uses: actions/download-artifact@v4
            with:
                name: tfstate
                path: ./terraform/team-01
         
          - name: Terraform Plan Destroy
            run: terraform plan -destroy -out=tfplan

          - name: Terraform Apply Destroy
            run: terraform apply -auto-approve tfplan